<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengurusan Dokumen & Acara | PPD Alor Gajah</title>
    <!-- Favicon Rasmi -->
    <link rel="icon" href="icoppdag.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .uppercase-input { text-transform: uppercase; }
        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        input, select, textarea { transition: all 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-900">

    <div class="max-w-4xl mx-auto p-4 sm:p-8 my-4 sm:my-8">
        <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
            
            <!-- Header Korporat -->
            <div class="px-6 py-10 text-center border-b border-slate-100 bg-slate-50/50">
                <img src="icoppdag.png" alt="Logo PPD Alor Gajah" class="h-28 mx-auto object-contain drop-shadow-sm mb-5">
                <h2 class="text-2xl sm:text-3xl font-extrabold text-slate-800 tracking-tight">Sistem Pengurusan Dokumen & Acara</h2>
                <p class="text-slate-500 text-sm sm:text-base mt-2 max-w-2xl mx-auto font-medium">Pejabat Pendidikan Daerah Alor Gajah. Sila muat naik dokumen dahulu, kemudian lengkapkan maklumat pendaftaran di bawah. (<span class="text-red-500">*</span> Wajib)</p>
            </div>

            <form id="mainForm" class="p-6 sm:p-10" onsubmit="handleFormSubmit(event)">
                
                <div id="messageBox" class="hidden mb-8 p-4 rounded-lg font-medium text-sm border"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    
                    <!-- FASA 0: MUAT NAIK FAIL (EARLY UPLOAD) -->
                    <div class="col-span-1 md:col-span-2 p-6 bg-indigo-50/30 rounded-xl border border-indigo-100 mb-2">
                        <label for="salinanSurat" class="block text-xs font-bold text-indigo-600 uppercase tracking-wider mb-3">Langkah 1: Muat Naik Salinan Dokumen <span class="text-red-500">*</span></label>
                        <div id="uploadContainer" class="relative">
                            <input id="salinanSurat" type="file" accept=".pdf, image/*" onchange="handleEarlyUpload(this)" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer">
                            
                            <div id="uploadStatus" class="mt-4 hidden items-center space-x-3 bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                                <div id="uploadLoader" class="loader"></div>
                                <span id="uploadText" class="text-sm font-medium text-slate-600">Sedang menyediakan fail...</span>
                                <a id="fileLink" href="#" target="_blank" class="hidden text-sm font-bold text-emerald-600 underline truncate flex-1">Lihat Fail Drive</a>
                                <button type="button" id="resetFileBtn" onclick="resetFileUpload()" class="hidden text-xs text-red-500 font-bold hover:bg-red-50 px-2 py-1 rounded">Padam</button>
                            </div>
                        </div>
                    </div>

                    <!-- FASA 1: MAKLUMAT SEKTOR & UNIT -->
                    <div class="col-span-1">
                        <label for="sektor" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Sektor <span class="text-red-500">*</span></label>
                        <select id="sektor" name="sektor" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-slate-100" onchange="populateUnit()">
                            <option value="">Sila pilih sektor...</option>
                        </select>
                    </div>

                    <div class="col-span-1">
                        <label for="unit" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Unit <span class="text-red-500">*</span></label>
                        <select id="unit" name="unit" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-slate-100" disabled onchange="populateNama()">
                            <option value="">Pilih Sektor Dahulu</option>
                        </select>
                    </div>

                    <!-- FASA 2: PENERIMA -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Nama Penerima (Berbilang Pilihan) <span class="text-red-500">*</span></label>
                        <div id="namaContainer" class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-slate-50 h-40 overflow-y-auto custom-scrollbar focus-within:bg-white transition-colors">
                            <div class="text-slate-400 italic text-sm mt-1">Sila Pilih Unit Dahulu</div>
                        </div>
                    </div>

                    <div class="col-span-1 md:col-span-2">
                        <label for="email" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Alamat Emel Penerima (Auto) <span class="text-red-500">*</span></label>
                        <textarea id="email" name="email" required readonly rows="2" class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-slate-100 cursor-not-allowed text-slate-500 custom-scrollbar"></textarea>
                    </div>

                    <!-- FASA 3: TARIKH & MASA -->
                    <div class="col-span-1">
                        <label for="tarikhTerima" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tarikh Terima Surat <span class="text-red-500">*</span></label>
                        <input type="date" id="tarikhTerima" name="tarikhTerima" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white">
                    </div>

                    <div class="col-span-1">
                        <label for="tarikhProgram" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tarikh Mula Program <span class="text-red-500">*</span></label>
                        <input type="date" id="tarikhProgram" name="tarikhProgram" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white">
                    </div>

                    <div class="col-span-1">
                        <label for="bilanganHari" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Bilangan Hari <span class="text-red-500">*</span></label>
                        <input type="number" id="bilanganHari" name="bilanganHari" min="1" value="1" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white">
                    </div>

                    <div class="col-span-1 flex space-x-2">
                        <div class="flex-1">
                            <label for="masaMula" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Mula <span class="text-red-500">*</span></label>
                            <input type="time" id="masaMula" name="masaMula" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white">
                        </div>
                        <div class="flex-1">
                            <label for="masaTamat" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tamat <span class="text-red-500">*</span></label>
                            <input type="time" id="masaTamat" name="masaTamat" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white">
                        </div>
                    </div>

                    <!-- FASA 4: TAJUK -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="tajukProgram" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tajuk Program (Huruf Besar) <span class="text-red-500">*</span></label>
                        <input type="text" id="tajukProgram" name="tajukProgram" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white uppercase-input placeholder-slate-400 font-medium" placeholder="Cth: TAKLIMAT PENGURUSAN DOKUMEN 2024">
                    </div>

                </div>

                <div class="mt-10 flex justify-end border-t border-slate-100 pt-6">
                    <button type="submit" id="submitBtn" class="bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-bold py-4 px-10 rounded-xl shadow-md hover:shadow-xl transition-all duration-200 flex items-center transform hover:-translate-y-0.5">
                        <span id="btnText" class="flex items-center text-sm tracking-widest uppercase">Simpan & Hantar Rekod</span>
                    </button>
                </div>
            </form>
        </div>
        
        <div class="text-center mt-6 mb-8">
            <p class="text-xs font-medium text-slate-400">&copy; <span id="currentYear"></span> Pejabat Pendidikan Daerah Alor Gajah.</p>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const SUPABASE_URL = 'https://app.tech4ag.my';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNzYzMzczNjQ1LCJleHAiOjIwNzg3MzM2NDV9.vZOedqJzUn01PjwfaQp7VvRzSm4aRMr21QblPDK8AoY';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxdxhnRfdGgo-6cAOGP3cTS4gm9wicFy3Df_6a9GPAb49TUbCcUEH93ncy_ikUIuJY/exec';
        
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let groupedData = {};
        let uploadedFileUrl = "";

        // Init Data dari Supabase
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            try {
                const { data, error } = await _supabase.from('memo_pegawai').select('*').order('sektor');
                if (error) throw error;
                processPegawai(data);
                populateSektor();
            } catch (err) {
                showMessage("Ralat pangkalan data: " + err.message, 'error');
            }
        });

        function processPegawai(data) {
            groupedData = {};
            data.forEach(p => {
                if (!groupedData[p.sektor]) groupedData[p.sektor] = {};
                if (!groupedData[p.sektor][p.unit]) groupedData[p.sektor][p.unit] = [];
                groupedData[p.sektor][p.unit].push({ nama: p.nama, emel: p.emel_rasmi });
            });
        }

        function populateSektor() {
            const s = document.getElementById('sektor');
            s.innerHTML = '<option value="">-- PILIH SEKTOR --</option>';
            Object.keys(groupedData).sort().forEach(sk => {
                const opt = document.createElement('option');
                opt.value = sk; opt.textContent = sk;
                s.appendChild(opt);
            });
        }

        function populateUnit() {
            const sk = document.getElementById('sektor').value;
            const u = document.getElementById('unit');
            const nc = document.getElementById('namaContainer');
            u.innerHTML = '<option value="">-- PILIH UNIT --</option>';
            u.disabled = true;
            nc.innerHTML = '<div class="text-slate-400 italic text-sm mt-1">Sila Pilih Unit Dahulu</div>';
            
            if (sk && groupedData[sk]) {
                Object.keys(groupedData[sk]).sort().forEach(un => {
                    const opt = document.createElement('option');
                    opt.value = un; opt.textContent = un;
                    u.appendChild(opt);
                });
                u.disabled = false;
            }
        }

        function populateNama() {
            const sk = document.getElementById('sektor').value;
            const un = document.getElementById('unit').value;
            const nc = document.getElementById('namaContainer');
            nc.innerHTML = '';
            
            if (sk && un && groupedData[sk][un]) {
                groupedData[sk][un].sort((a,b)=>a.nama.localeCompare(b.nama)).forEach((p,i) => {
                    nc.innerHTML += `
                        <div class="flex items-center mb-2 hover:bg-indigo-50 p-2 rounded transition-colors">
                            <input type="checkbox" id="c_${i}" name="penerima" value="${p.nama}" data-email="${p.emel}" onchange="updateEmails()" class="w-4 h-4 text-indigo-600 rounded">
                            <label for="c_${i}" class="ml-3 text-sm font-semibold text-slate-700 cursor-pointer">${p.nama}</label>
                        </div>`;
                });
            } else {
                nc.innerHTML = '<div class="text-slate-400 italic text-sm mt-1">Sila Pilih Unit Dahulu</div>';
            }
        }

        function updateEmails() {
            const chks = document.querySelectorAll('input[name="penerima"]:checked');
            document.getElementById('email').value = Array.from(chks).map(c => c.getAttribute('data-email')).join(', ');
        }

        // EARLY UPLOAD LOGIC
        async function handleEarlyUpload(input) {
            if (!input.files || input.files.length === 0) return;
            
            const file = input.files[0];
            const statusDiv = document.getElementById('uploadStatus');
            const loader = document.getElementById('uploadLoader');
            const text = document.getElementById('uploadText');
            const link = document.getElementById('fileLink');
            const resetBtn = document.getElementById('resetFileBtn');

            statusDiv.classList.remove('hidden');
            loader.classList.remove('hidden');
            text.textContent = "Sedang memuat naik fail ke Drive...";
            link.classList.add('hidden');
            resetBtn.classList.add('hidden');
            input.disabled = true;

            try {
                const base64Full = await toBase64(file);
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'upload',
                        fileBase64: base64Full.split(',')[1],
                        fileName: file.name,
                        fileMimeType: file.type
                    })
                });
                const data = await res.json();
                if (data.status !== 'success') throw new Error(data.message);

                uploadedFileUrl = data.fileUrl;
                text.textContent = "Berjaya: ";
                loader.classList.add('hidden');
                link.href = uploadedFileUrl;
                link.classList.remove('hidden');
                resetBtn.classList.remove('hidden');
                
                showMessage("Muat naik fail berjaya. Sila lengkapkan maklumat lain.", "info");
            } catch (err) {
                text.textContent = "Ralat: " + err.message;
                loader.classList.add('hidden');
                input.disabled = false;
                showMessage("Gagal muat naik fail: " + err.message, "error");
            }
        }

        function resetFileUpload() {
            uploadedFileUrl = "";
            const input = document.getElementById('salinanSurat');
            input.value = "";
            input.disabled = false;
            document.getElementById('uploadStatus').classList.add('hidden');
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // SUBMIT LOGIC
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!uploadedFileUrl) return showMessage("Sila muat naik dokumen dahulu (Langkah 1).", "error");
            
            const checked = document.querySelectorAll('input[name="penerima"]:checked');
            if (checked.length === 0) return showMessage("Pilih sekurang-kurangnya 1 penerima.", "error");

            setLoading(true, "Menyimpan Data...");

            try {
                const names = Array.from(checked).map(c => c.value);
                const emels = Array.from(checked).map(c => c.getAttribute('data-email'));

                // 1. Simpan ke Supabase
                const { data: rec, error: subError } = await _supabase.from('memo_rekod').insert([{
                    sektor: document.getElementById('sektor').value,
                    unit: document.getElementById('unit').value,
                    nama_penerima: names.join(', '),
                    emel_penerima: emels.join(', '),
                    tarikh_terima: document.getElementById('tarikhTerima').value,
                    tarikh_program: document.getElementById('tarikhProgram').value,
                    bilangan_hari: parseInt(document.getElementById('bilanganHari').value),
                    tajuk_program: document.getElementById('tajukProgram').value.toUpperCase(),
                    masa_mula: document.getElementById('masaMula').value,
                    masa_tamat: document.getElementById('masaTamat').value,
                    file_url: uploadedFileUrl
                }]).select();

                if (subError) throw subError;

                setLoading(true, "Menghantar Notifikasi...");

                // 2. Notifikasi GAS (Emel & Kalendar)
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'notify',
                        sektor: document.getElementById('sektor').value,
                        unit: document.getElementById('unit').value,
                        namaArray: names,
                        emailArray: emels,
                        tarikhProgram: document.getElementById('tarikhProgram').value,
                        bilanganHari: document.getElementById('bilanganHari').value,
                        tajukProgram: document.getElementById('tajukProgram').value.toUpperCase(),
                        masaMula: document.getElementById('masaMula').value,
                        masaTamat: document.getElementById('masaTamat').value,
                        fileUrl: uploadedFileUrl
                    })
                });
                const notify = await res.json();

                if (notify.status === 'success') {
                    await _supabase.from('memo_rekod').update({ calendar_event_id: notify.calendarEventId }).eq('id', rec[0].id);
                }

                showMessage("<strong>Berjaya!</strong> Data disimpan, emel dihantar, dan kalendar dikemas kini.", "success");
                resetForm();
            } catch (err) {
                showMessage("Ralat Simpanan: " + err.message, "error");
            } finally {
                setLoading(false);
            }
        }

        function setLoading(status, txt) {
            const btn = document.getElementById('submitBtn');
            const bt = document.getElementById('btnText');
            btn.disabled = status;
            bt.innerHTML = status ? `<div class="loader"></div> <span class="ml-2">${txt}</span>` : "Simpan & Hantar Rekod";
        }

        function showMessage(m, t) {
            const b = document.getElementById('messageBox');
            b.innerHTML = m;
            b.className = `mb-8 p-4 rounded-lg font-medium text-sm border ${t==='error'?'bg-red-50 text-red-800 border-red-200':t==='success'?'bg-emerald-50 text-emerald-800 border-emerald-200':'bg-blue-50 text-blue-800 border-blue-200'}`;
            b.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('mainForm').reset();
            resetFileUpload();
            populateUnit();
        }
    </script>
</body>
</html>