<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengurusan Dokumen & Acara | PPD Alor Gajah</title>
    <!-- Favicon Rasmi -->
    <link rel="icon" href="icoppdag.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .uppercase-input { text-transform: uppercase; }
        /* Loader Spinner */
        .loader {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4f46e5; /* Indigo 600 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f8fafc; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        /* Smooth Input Transition */
        input, select, textarea {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-900">

    <div class="max-w-4xl mx-auto p-4 sm:p-8 my-4 sm:my-8">
        <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
            
            <!-- Header Korporat -->
            <div class="px-6 py-10 text-center border-b border-slate-100 bg-slate-50/50">
                <!-- Logo Rasmi -->
                <img src="icoppdag.png" alt="Logo PPD Alor Gajah" class="h-28 mx-auto object-contain drop-shadow-sm mb-5">
                <h2 class="text-2xl sm:text-3xl font-extrabold text-slate-800 tracking-tight">Sistem Pengurusan Dokumen & Acara</h2>
                <p class="text-slate-500 text-sm sm:text-base mt-2 max-w-2xl mx-auto font-medium">Pejabat Pendidikan Daerah Alor Gajah. Sila lengkapkan maklumat pendaftaran program dan muat naik dokumen sokongan di bawah. (<span class="text-red-500">*</span> Wajib)</p>
            </div>

            <form id="mainForm" class="p-6 sm:p-10" onsubmit="handleFormSubmit(event)">
                
                <!-- Notifikasi / Mesej (Sembunyi secara lalai) -->
                <div id="messageBox" class="hidden mb-8 p-4 rounded-lg font-medium text-sm border"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    
                    <!-- Dropdown Sektor -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="sektor" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Sektor <span class="text-red-500">*</span></label>
                        <select id="sektor" name="sektor" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed" onchange="populateUnit()">
                            <option value="">Memuatkan data...</option>
                        </select>
                    </div>

                    <!-- Dropdown Unit -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="unit" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Unit <span class="text-red-500">*</span></label>
                        <select id="unit" name="unit" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed" disabled onchange="populateNama()">
                            <option value="">Pilih Sektor Dahulu</option>
                        </select>
                    </div>

                    <!-- Checkbox Nama Penerima (Multi-select) -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Nama Penerima (Berbilang Pilihan) <span class="text-red-500">*</span></label>
                        <div id="namaContainer" class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-slate-50 h-48 overflow-y-auto custom-scrollbar focus-within:ring-2 focus-within:ring-indigo-500 focus-within:border-indigo-500 focus-within:bg-white transition-colors">
                            <div class="text-slate-400 italic text-sm mt-1">Sila Pilih Unit Dahulu</div>
                        </div>
                    </div>

                    <!-- Emel (Auto Populate & Readonly) -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="email" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Alamat Emel (Janaan Automatik) <span class="text-red-500">*</span></label>
                        <textarea id="email" name="email" required readonly rows="2" class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-slate-100 cursor-not-allowed text-slate-500 custom-scrollbar focus:outline-none"></textarea>
                    </div>

                    <!-- Tarikh Terima Surat -->
                    <div class="col-span-1 md:col-span-2 mt-2">
                        <label for="tarikhTerima" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tarikh Terima Surat <span class="text-red-500">*</span></label>
                        <input type="date" id="tarikhTerima" name="tarikhTerima" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-700">
                    </div>

                    <!-- Tarikh Program -->
                    <div>
                        <label for="tarikhProgram" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tarikh Mula Program <span class="text-red-500">*</span></label>
                        <input type="date" id="tarikhProgram" name="tarikhProgram" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-700">
                    </div>

                    <!-- Bilangan Hari -->
                    <div>
                        <label for="bilanganHari" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Bilangan Hari Program <span class="text-red-500">*</span></label>
                        <input type="number" id="bilanganHari" name="bilanganHari" min="1" value="1" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-700">
                    </div>

                    <!-- Masa Mula -->
                    <div>
                        <label for="masaMula" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Masa Mula <span class="text-red-500">*</span></label>
                        <input type="time" id="masaMula" name="masaMula" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-700">
                    </div>

                    <!-- Masa Tamat -->
                    <div>
                        <label for="masaTamat" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Masa Tamat <span class="text-red-500">*</span></label>
                        <input type="time" id="masaTamat" name="masaTamat" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-700">
                    </div>

                    <!-- Tajuk Program -->
                    <div class="col-span-1 md:col-span-2 mt-2">
                        <label for="tajukProgram" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tajuk Program (Rujuk Surat) <span class="text-red-500">*</span></label>
                        <input type="text" id="tajukProgram" name="tajukProgram" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-800 uppercase-input placeholder-slate-400 font-medium" placeholder="Cth: TAKLIMAT PENGURUSAN DOKUMEN 2024">
                    </div>

                    <!-- Muat Naik Salinan Surat -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="salinanSurat" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Salinan Dokumen (PDF / Imej) <span class="text-red-500">*</span></label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-lg hover:border-indigo-400 bg-slate-50 hover:bg-slate-50/50 transition-colors">
                            <div class="space-y-1 text-center w-full">
                                <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-slate-600 justify-center mt-2">
                                    <label for="salinanSurat" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 px-1">
                                        <span>Muat Naik Fail</span>
                                        <input id="salinanSurat" name="salinanSurat" type="file" accept=".pdf, image/*" required class="sr-only">
                                    </label>
                                    <p class="pl-1">atau seret dan lepas</p>
                                </div>
                                <p class="text-xs text-slate-500" id="fileNameDisplay">Hanya fail PDF, JPG, PNG diterima.</p>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="mt-10 flex justify-end border-t border-slate-100 pt-6">
                    <button type="submit" id="submitBtn" class="bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center transform hover:-translate-y-0.5">
                        <span id="btnText" class="flex items-center text-sm tracking-wide uppercase">Hantar Rekod Sistem</span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Footer -->
        <div class="text-center mt-6 mb-8">
            <p class="text-xs font-medium text-slate-400">&copy; <span id="currentYear"></span> Pejabat Pendidikan Daerah Alor Gajah. Hak Cipta Terpelihara.</p>
        </div>
    </div>

    <script>
        // Set tahun semasa untuk footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Papar nama fail apabila dipilih
        document.getElementById('salinanSurat').addEventListener('change', function(e) {
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            if (this.files && this.files.length > 0) {
                fileNameDisplay.innerHTML = `<span class="font-bold text-indigo-600">${this.files[0].name}</span>`;
            } else {
                fileNameDisplay.textContent = 'Hanya fail PDF, JPG, PNG diterima.';
            }
        });

        // CONFIGURATION: Google Apps Script Web App URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzjygoZPwqWRz3I4JyuABWJxznc-CzF5l3F2yrrYlke-N5bVopGCDx5yCmbKKUBZdRh/exec';
        
        let globalData = {};

        // Inisialisasi: Dapatkan data apabila halaman dimuatkan melalui API Fetch
        document.addEventListener('DOMContentLoaded', function() {
            fetch(GAS_WEB_APP_URL)
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        onDataLoaded(result.data);
                    } else {
                        onDataError(result.message);
                    }
                })
                .catch(error => {
                    onDataError("Gagal berhubung dengan pelayan pusat. Sila semak sambungan rangkaian anda.");
                });
        });

        function onDataLoaded(data) {
            globalData = data;
            const sektorSelect = document.getElementById('sektor');
            
            sektorSelect.innerHTML = '<option value="">-- SILA PILIH SEKTOR --</option>';
            
            const sektorList = Object.keys(data).sort();
            sektorList.forEach(sektor => {
                const option = document.createElement('option');
                option.value = sektor;
                option.textContent = sektor;
                sektorSelect.appendChild(option);
            });
            
            sektorSelect.disabled = false;
        }

        function onDataError(error) {
            showMessage("Ralat sistem backend: " + error, 'error');
            const sektorSelect = document.getElementById('sektor');
            sektorSelect.innerHTML = '<option value="">RALAT RANGKAIAN</option>';
        }

        function populateUnit() {
            const sektorValue = document.getElementById('sektor').value;
            const unitSelect = document.getElementById('unit');
            const namaContainer = document.getElementById('namaContainer');
            const emailInput = document.getElementById('email');

            // Reset
            unitSelect.innerHTML = '<option value="">-- SILA PILIH UNIT --</option>';
            unitSelect.disabled = true;
            namaContainer.innerHTML = '<div class="text-slate-400 italic text-sm mt-1">Sila Pilih Unit Dahulu</div>';
            emailInput.value = '';

            if (sektorValue && globalData[sektorValue]) {
                const unitList = Object.keys(globalData[sektorValue]).sort();
                unitList.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    unitSelect.appendChild(option);
                });
                unitSelect.disabled = false;
            }
        }

        function populateNama() {
            const sektorValue = document.getElementById('sektor').value;
            const unitValue = document.getElementById('unit').value;
            const namaContainer = document.getElementById('namaContainer');
            const emailInput = document.getElementById('email');

            // Reset
            namaContainer.innerHTML = '';
            emailInput.value = '';

            if (sektorValue && unitValue && globalData[sektorValue][unitValue]) {
                const pegawaiList = globalData[sektorValue][unitValue];
                
                // Susun ikut abjad
                pegawaiList.sort((a, b) => a.nama.localeCompare(b.nama));
                
                if (pegawaiList.length === 0) {
                    namaContainer.innerHTML = '<div class="text-slate-400 italic text-sm mt-1">Tiada rekod pegawai dalam unit ini.</div>';
                    return;
                }

                pegawaiList.forEach((pegawai, index) => {
                    const wrapperDiv = document.createElement('div');
                    wrapperDiv.className = 'flex items-start mb-2 hover:bg-indigo-50/50 p-2 rounded-md transition-colors border border-transparent hover:border-indigo-100';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = 'chk_' + index;
                    checkbox.name = 'penerimaCheckbox';
                    checkbox.value = pegawai.nama;
                    checkbox.className = 'w-4 h-4 mt-0.5 text-indigo-600 bg-white border-slate-300 rounded focus:ring-indigo-500 cursor-pointer';
                    checkbox.setAttribute('data-email', pegawai.emel);
                    checkbox.onchange = updateSelectedEmails;

                    const label = document.createElement('label');
                    label.htmlFor = 'chk_' + index;
                    label.className = 'ml-3 text-sm font-semibold text-slate-700 cursor-pointer select-none';
                    label.textContent = pegawai.nama;

                    wrapperDiv.appendChild(checkbox);
                    wrapperDiv.appendChild(label);
                    namaContainer.appendChild(wrapperDiv);
                });
            } else {
                namaContainer.innerHTML = '<div class="text-slate-400 italic text-sm mt-1">Sila Pilih Unit Dahulu</div>';
            }
        }

        function updateSelectedEmails() {
            const checkboxes = document.querySelectorAll('input[name="penerimaCheckbox"]:checked');
            const emails = [];
            
            checkboxes.forEach(chk => {
                const emel = chk.getAttribute('data-email');
                if (emel) {
                    emails.push(emel);
                }
            });
            
            document.getElementById('email').value = emails.join(', ');
        }

        function showMessage(msg, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.innerHTML = msg; // membenarkan HTML parsing seperti <strong>
            messageBox.classList.remove('hidden', 'bg-red-50', 'text-red-800', 'border-red-200', 'bg-emerald-50', 'text-emerald-800', 'border-emerald-200', 'bg-blue-50', 'text-blue-800', 'border-blue-200');
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
            } else if (type === 'success') {
                messageBox.classList.add('bg-emerald-50', 'text-emerald-800', 'border-emerald-200');
            } else {
                messageBox.classList.add('bg-blue-50', 'text-blue-800', 'border-blue-200');
            }
            
            // Tatal lancar ke atas borang
            document.getElementById('mainForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function setLoadingState(isLoading) {
            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const formElements = document.getElementById('mainForm').elements;
            const checkboxes = document.querySelectorAll('input[name="penerimaCheckbox"]');
            
            if (isLoading) {
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-wait');
                btn.classList.remove('hover:-translate-y-0.5', 'hover:shadow-lg');
                btnText.innerHTML = '<div class="loader"></div> <span class="text-sm tracking-wide uppercase">Sistem Sedang Memproses...</span>';
                
                for (let i = 0; i < formElements.length; i++) {
                    formElements[i].disabled = true;
                }
                checkboxes.forEach(chk => chk.disabled = true);
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-wait');
                btn.classList.add('hover:-translate-y-0.5', 'hover:shadow-lg');
                btnText.innerHTML = '<span class="text-sm tracking-wide uppercase">Hantar Rekod Sistem</span>';
                
                for (let i = 0; i < formElements.length; i++) {
                    if (formElements[i].id !== 'unit' && formElements[i].id !== 'email') {
                        formElements[i].disabled = false;
                    }
                }
                checkboxes.forEach(chk => chk.disabled = false);
                
                if (document.getElementById('sektor').value) document.getElementById('unit').disabled = false;
            }
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            
            const checkedBoxes = document.querySelectorAll('input[name="penerimaCheckbox"]:checked');
            if (checkedBoxes.length === 0) {
                showMessage("<strong>Ralat Borang:</strong> Sila pilih sekurang-kurangnya seorang (1) Nama Penerima.", 'error');
                return;
            }
            
            const fileInput = document.getElementById('salinanSurat');
            if (fileInput.files.length === 0) {
                showMessage("<strong>Ralat Borang:</strong> Sila muat naik fail salinan dokumen rasmi.", 'error');
                return;
            }

            const senaraiNama = Array.from(checkedBoxes).map(chk => chk.value);
            const senaraiEmel = Array.from(checkedBoxes).map(chk => chk.getAttribute('data-email')).filter(Boolean);

            setLoadingState(true);
            showMessage("Sistem sedang memuat naik fail selamat dan memproses data rekod. Sila tunggu sebentar...", 'info');

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const dataUrl = e.target.result;
                const base64Data = dataUrl.split(',')[1];

                const formData = {
                    sektor: document.getElementById('sektor').value,
                    unit: document.getElementById('unit').value,
                    namaArray: senaraiNama,
                    emailArray: senaraiEmel,
                    tarikhTerima: document.getElementById('tarikhTerima').value,
                    tarikhProgram: document.getElementById('tarikhProgram').value,
                    bilanganHari: document.getElementById('bilanganHari').value,
                    tajukProgram: document.getElementById('tajukProgram').value.toUpperCase(),
                    masaMula: document.getElementById('masaMula').value,
                    masaTamat: document.getElementById('masaTamat').value,
                    fileBase64: base64Data,
                    fileName: file.name,
                    fileMimeType: file.type
                };

                // Panggilan API POST ke Google Apps Script
                fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    redirect: 'follow'
                })
                .then(response => response.json())
                .then(result => {
                    onSubmissionSuccess(result);
                })
                .catch(error => {
                    onSubmissionError({ message: error.toString() });
                });
            };
            
            reader.onerror = function() {
                setLoadingState(false);
                showMessage("<strong>Ralat Sistem:</strong> Gagal membaca data fail fizikal. Sila cuba fail lain.", 'error');
            };

            reader.readAsDataURL(file);
        }

        function onSubmissionSuccess(response) {
            setLoadingState(false);
            if (response.status === 'success') {
                showMessage(`<strong>Berjaya!</strong> ${response.message}`, 'success');
                document.getElementById('mainForm').reset();
                
                // Reset elemen manual
                document.getElementById('unit').innerHTML = '<option value="">Pilih Sektor Dahulu</option>';
                document.getElementById('unit').disabled = true;
                document.getElementById('namaContainer').innerHTML = '<div class="text-slate-400 italic text-sm mt-1">Sila Pilih Unit Dahulu</div>';
                document.getElementById('email').value = '';
                document.getElementById('fileNameDisplay').textContent = 'Hanya fail PDF, JPG, PNG diterima.';
                
                // Defaultkan semula bilangan hari
                document.getElementById('bilanganHari').value = 1;
            } else {
                showMessage(`<strong>Ralat Logik Backend:</strong> ${response.message}`, 'error');
            }
        }

        function onSubmissionError(error) {
            setLoadingState(false);
            showMessage(`<strong>Ralat Pelayan:</strong> Transmisi data terputus. ${error.message}`, 'error');
        }
    </script>
</body>
</html>